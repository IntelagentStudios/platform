<!DOCTYPE html>
<html>
<head>
    <title>Debug Login</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { padding: 10px; margin: 5px; }
        #log { background: #f0f0f0; padding: 10px; margin-top: 20px; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Debug Login Test</h1>
    
    <button onclick="testSimpleRedirect()">1. Test Simple Redirect</button>
    <button onclick="testLogin()">2. Test Login API</button>
    <button onclick="testFullLogin()">3. Test Full Login Flow</button>
    
    <div id="log">Log output will appear here...</div>
    
    <script>
        const log = (msg, isError = false) => {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toISOString().substr(11, 8);
            const className = isError ? 'error' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${msg}</span>\n`;
            console.log(msg);
        };
        
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            log('ERROR: ' + msg + ' at line ' + lineNo, true);
            return false;
        };
        
        window.addEventListener('unhandledrejection', function(event) {
            log('Unhandled promise rejection: ' + event.reason, true);
        });
        
        function testSimpleRedirect() {
            try {
                log('Testing simple redirect to /dashboard...');
                window.location.href = '/dashboard';
            } catch (e) {
                log('Redirect error: ' + e.message, true);
            }
        }
        
        async function testLogin() {
            try {
                log('Testing login API...');
                
                const response = await fetch('/api/auth/login-simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'harry@intelagentstudios.com',
                        password: 'Birksgrange226!'
                    })
                });
                
                log('Response status: ' + response.status);
                
                const text = await response.text();
                log('Response text: ' + text.substring(0, 200));
                
                try {
                    const data = JSON.parse(text);
                    log('Parsed response: ' + JSON.stringify(data, null, 2));
                    
                    if (response.ok && data.success) {
                        log('Login successful!', false);
                    }
                } catch (e) {
                    log('Could not parse as JSON: ' + e.message, true);
                }
                
            } catch (e) {
                log('API error: ' + e.message, true);
                log('Stack: ' + e.stack, true);
            }
        }
        
        async function testFullLogin() {
            try {
                log('Testing full login flow...');
                
                const response = await fetch('/api/auth/login-simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'harry@intelagentstudios.com',
                        password: 'Birksgrange226!'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    log('Login successful! Attempting redirect in 2 seconds...', false);
                    
                    setTimeout(() => {
                        try {
                            log('Redirecting now...');
                            window.location.href = '/dashboard';
                        } catch (e) {
                            log('Redirect failed: ' + e.message, true);
                        }
                    }, 2000);
                } else {
                    log('Login failed: ' + (data.error || 'Unknown'), true);
                }
                
            } catch (e) {
                log('Full flow error: ' + e.message, true);
                log('Stack: ' + e.stack, true);
            }
        }
        
        // Test console
        log('Debug page loaded successfully');
        log('Ready for testing...');
    </script>
</body>
</html>